<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Groupie Tracker - Évènements</title>
    <link rel="stylesheet" href="/css/accueil.css">
    <link rel="stylesheet" href="/css/concerts.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 700px; width: 95%; margin: 20px auto; border-radius: 15px; border: 2px solid #333; z-index: 1; }
        #container-groupie_title { position: relative; z-index: 1000; }
        /* Style de secours pour la barre si le CSS ne charge pas */
        .search-form { display: flex; gap: 10px; justify-content: center; padding: 10px; }
    </style>
</head>
<body>
    
    <div id="container-groupie_title">
        <nav>
            <div class="groupie_title">
                <h1><a href="/">GROUPIE TRACKER</a></h1>
            </div>
            <div class="search-bar">
                    <form class="search-form" action="/search" method="POST">
                        <div class="input-container">
                            <input required placeholder="Search artists..." class="search-input" id="text-search" type="text" name="search-bar" list="suggestions-list" autocomplete="off"/>
                            <a href="/concerts" style="text-decoration: none; color: #666; font-size: 13px; margin-left: 10px; align-self: center;">
                            Delete the search
                            <datalist id="suggestions-list">
                                {{range $artist := .Artists}}
                                <option value="{{$artist.Name}}">{{$artist.Name}}</option>
                                {{range $artist.Members}}
                                <option value="{{.}}">{{.}} (member of {{$artist.Name}})</option>
                                {{end}}
                                {{end}}
                            </datalist>
                        </div>

                        <button class="submit-button" type="submit">
                            <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" class="icon-submit">
                                <path d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" stroke="currentColor"></path>
                            </svg>
                            <p>Search</p>
                        </button>
                    </form>
                </div>
            <ul class="groupie_artists">
                <li><a href="/">Home</a></li>
                <li><a href="/artists">Artists</a></li>
                <li><a href="/concerts">Events</a></li>
            </ul>
        </nav>
    </div>

    <div id="map" data-markers="{{.MarkersJSON}}"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var mapElement = document.getElementById('map');
            var rawData = mapElement.getAttribute('data-markers');
            
            var map = L.map('map').setView([20, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            setTimeout(function(){ map.invalidateSize() }, 400);

            try {
                if (rawData && rawData !== "") {
                    var markers = JSON.parse(rawData);
                    if (markers && markers.length > 0) {
                        var group = new L.featureGroup();
                        markers.forEach(function(loc) {
                            var city = loc.city.replace(/_/g, ' ').replace(/-/g, ', ');
                            var m = L.marker([loc.lat, loc.lng])
                                     .addTo(map)
                                     .bindPopup("<b>"+loc.artist+"</b><br>"+city);
                            group.addLayer(m);
                        });
                        map.fitBounds(group.getBounds(), {padding: [50, 50]});
                    }
                }
            } catch (e) { console.error("Erreur de données :", e); }
        });
    </script>
</body>
</html>